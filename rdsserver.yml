---
- name: provision stack
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    cluster_name: "{{environment_name}}-factset-rds-up"

  tasks:
  - name: launch RDS cloudformation 
    cloudformation:
      stack_name: upp-{{environment_name}}-factset-rds
      state: present
      region: eu-west-1
      disable_rollback: true
      template: cloudformation/rds.yaml
      template_parameters:
        EnvironmentName: "{{environment_name}}"
        VPC: vpc-36639c52
        SecurityGroup: sg-28bc5a51
        DBName: Factset
        DBClass: db.t2.small
        DBUser: AdminUser
        DBPassword: 5up3r53cur3p455w0rd
    register: rds_stack
  - name: show stack outputs
    debug:
      msg: "My stack outputs are {{rds_stack.stack_outputs}}"
  - name: Save RDS host name
    set_fact:
      rds_hostname: "{{rds_stack.stack_outputs.DBHostname}}"
  - name: Perform a lookup on the cluster CNAME
    set_fact:
      dns_lookup_output: "{{ lookup('dig', '{{cluster_name}}.in.ft.com/CNAME') }}"
  - name: If it already exists, update the existing CNAME record
    uri:
      url: https://dns-api.in.ft.com/v2/
      method: PUT
      HEADER_x-api-key: "{{konstructor_api_key}}"
      body:
        zone: ft.com
        name: "{{cluster_name}}.in"
        # trim the last character of the FQDN - Dyn doesn't like the trailing dot
        oldRdata: "{{dns_lookup_output[:-1]}}"
        newRdata: "{{rds_hostname}}"
        ttl: "300"
        emailAddress: "universal.publishing.platform@ft.com"
      body_format: json
    register: dns_update_output
    when: dns_lookup_output != "NXDOMAIN"
  - debug:
      msg: "{{dns_update_output}}"
  - name: If it doesn't exist, create a new CNAME record
    uri:
      url: https://dns-api.in.ft.com/v2/
      method: POST
      HEADER_x-api-key: "{{konstructor_api_key}}"
      body:
        zone: ft.com
        name: "{{cluster_name}}.in"
        rdata: "{{rds_hostname}}"
        ttl: "300"
        emailAddress: "universal.publishing.platform@ft.com"
      body_format: json
    register: dns_create_output
    when: dns_lookup_output == "NXDOMAIN"
  - debug:
      msg: "{{dns_create_output}}"
